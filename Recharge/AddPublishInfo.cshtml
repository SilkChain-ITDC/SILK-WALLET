@using SKC.Entity.DBModels
@using SKC.Entity.Models
@using SKC.Entity.Enums
@using Newtonsoft.Json;
@{
    Layout = "/Views/Shared/_Layout.cshtml";
    List<SkcSkcpublish>   list = ViewBag.DataList;
}
    <style>
        .table tr:first-child > td {
            border-top: 0px solid #f4f5f8;
        }

        .table tr > td:last-child {
            padding-right: 30px;
        }

        .table th, .table td {
            height: 69px;
            font-size: 16px;
        }

        .table th, .table td {
            border-bottom: 1px solid #CCCCCC;
            border-top: none;
        }

        .light-color {
            color: #A9A9A9;
        }

        .cny-color {
            color: #d7202b;
        }

        .no-bd-btm {
            border-bottom: none !important;
        }

        .table thead th {
            text-transform: none;
        }

        .m-content {
            height: 100%;
        }

        .m-portlet {
            margin-bottom: 0;
        }

        #purchase-div {
            height: 100%;
        }

        .activitytabpos {
            height: 24px;
            line-height: 24px;
        }
    </style>
    <div class="m-grid__item m-grid__item--fluid m-wrapper">
        <div class="m-content">
            <div class="row" id="purchase-div">
                <div class="col-lg-12">
                    <div class="m-portlet m-portlet--mobile">
                        <div class="m-portlet__head" style="border-bottom:1px solid #CCCCCC;">
                            <div class="m-portlet__head-caption">
                                <div class="m-portlet__head-title">
                                    <h3 class="m-portlet__head-text" style="font-weight:700;font-size:16px !important;">Offline Purchase Record</h3>
                                </div>
                            </div>
                        </div>
                        <div class="m-portlet__body" style="padding:0 25px 25px 0;">
                            <div class="m-scrollable mCustomScrollbar _mCS_3 mCS-autoHide" data-scrollable="true" data-scrollbar-shown="true" style="overflow: visible;">
                                <div id="mCSB_3" class="mCustomScrollBox mCS-minimal-dark mCSB_vertical mCSB_outside" style="max-height: none;" tabindex="0">
                                    <div id="mCSB_3_container" class="mCSB_container" style="position: relative; top: 0px; left: 0px;" dir="ltr">
                                        <div style="padding:0px 0px 25px 25px">
                                            <div class="table-responsive">
                                                <table class="table" id="activityTable" style="width: 100%">
                                                    <thead>
                                                        <tr>
                                                            <th>DateTime</th>
                                                            <th class="text-right">@SKC.Common.GlobalConfig.Coin_FullName</th>
                                                            <th class="text-right">PaymentMethod</th>
                                                            <th class="text-center">PaymentAddress</th>
                                                            <th class="text-center">SilkAddress</th>
                                                            <th class="text-center">Status</th>
                                                            <th class="text-center">Opt</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @if (list != null && list.Count > 0)
                                                        {
                                                            foreach (SkcSkcpublish item in list)
                                                            {
                                                                <tr>
                                                                    <td>@item.UpdateTimeDatetime.ToString("yyyy-MM-dd")</td>
                                                                    <td class="text-right"><span class="ezt-color">@item.AmountDecimal.ToString("N3") @SKC.Common.GlobalConfig.Coin_ShortName</span></td>
                                                                    <td class="text-right">-
                                                                        @*<span class="cny-color">
                                                                            @if (item.CoinTypeNvarchar == "RMB")
                                                                            {<span>￥</span>@item.DealAmountDecimal.ToString("N2")}
                                                                        else
                                                                        {@item.DealAmountDecimal.ToString("N2") @item.CoinTypeNvarchar}
                                                                        </span>*@
                                                                    </td>
                                                                    <td>
                                                                        @if (!string.IsNullOrEmpty(item.FinanceAddressNvarchar))
                                                                        {
                                                                            var adress = Newtonsoft.Json.JsonConvert.DeserializeObject<ReceiptAdressJsonModel>
                                                                                (item.FinanceAddressNvarchar);
                                                                            @if (item.CoinTypeNvarchar == "USD")
                                                                            {
                                                                                <span>
                                                                                    BackName：@adress.BankName<br />
                                                                                    BankAccount：@adress.BankNo<br />
                                                                                    PayeeName：@adress.ReceiptName
                                                                                </span>
                                                                            }
                                                                            else
                                                                            {
                                                                                @adress.Adress
                                                                            }
                                                                        }
                                                                    </td>
                                                                    <td class="text-center">@item.UserSilkAddressNvarchar</td>
                                                                    <td class="text-center">
                                                                        @if (item.StatusInt == (int)SKCPublishStatus.付款)
                                                                        {
                                                                            <span>pending</span>
                                                                        }
                                                                        @if (item.StatusInt == (int)SKCPublishStatus.确认收款)
                                                                        {
                                                                            <span>finish</span>
                                                                        }
                                                                        @if (item.StatusInt == (int)SKCPublishStatus.填写收款地址)
                                                                        {
                                                                            <span>unpaid</span>
                                                                        }
                                                                    </td>
                                                                    <td class="text-center">
                                                                        @if (item.StatusInt == (int)SKCPublishStatus.填写收款地址)
                                                                        {
                                                                            if (!string.IsNullOrEmpty(item.UserSilkAddressNvarchar))
                                                                            {
                                                                                <a href="javascript:;" onclick="showadress('@item.PublishIdNvarchar','@item.UserSilkAddressNvarchar')" data-toggle="modal">Update your Silk address</a>
                                                                                <br /><a href="javascript:;" onclick="paid('@item.PublishIdNvarchar')">paid</a>
                                                                            }
                                                                            else
                                                                            {
                                                                                <a href="javascript:;" onclick="showadress('@item.PublishIdNvarchar','@item.UserSilkAddressNvarchar')" data-toggle="modal">Enter your Silk address</a>
                                                                            }
                                                                        }
                                                                    </td>
                                                                </tr>
                                                            }
                                                        }
                                                        else
                                                        {
                                                            <tr><td colspan="6">No data available in table</td></tr>
                                                        }
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="activitytabpos desc-info light-color">your SilkToken is still in freezing period, according to contract, you can withdraw it after unlock</div>
                                        </div>
                                    </div>
                                </div>
                                <div id="mCSB_3_scrollbar_vertical" class="mCSB_scrollTools mCSB_3_scrollbar mCS-minimal-dark mCSB_scrollTools_vertical" style="display: block;">
                                    <div class="mCSB_draggerContainer">
                                        <div id="mCSB_3_dragger_vertical" class="mCSB_dragger" style="position: absolute; min-height: 50px; display: block; height: 82px; max-height: 234px; top: 0px;">
                                            <div class="mCSB_dragger_bar" style="line-height: 50px;"></div>
                                        </div>
                                        <div class="mCSB_draggerRail"></div>
                                    </div>
                                </div>
                                <div class="modal fade" id="J_modal_add_purchase" tabindex="-1" role="dialog" style="display:none;" aria-hidden="true">
                                    <div class="modal-dialog modal-lg" role="document">
                                        <div class="modal-content">
                                            <form action="/Recharge/AddPublishInfo" method="POST" id="J_add_purchase_form">
                                                <div class="modal-header">
                                                    <h5 class="modal-title">Enter your Silk address</h5>
                                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                        <span aria-hidden="true">×</span>
                                                    </button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="form-group m-form__group">
                                                        <input type="hidden" id="PublishId" />
                                                        <input type="text" class="form-control m-input form-control-sm" id="UserSilkAddress" name="UserSilkAddress" required>
                                                    </div>
                                                </div>
                                                <div style="border-top: 1px solid #e9ecef;padding:15px 25px 25px">
                                                    <div class="row" style="margin-bottom: 15px"><div class="col-lg-12"></div></div>
                                                    <div class="row">
                                                        <div class="col-lg-12 text-right">
                                                            <button type="reset" class="btn btn-default m-btn--pill" data-dismiss="modal">取消</button>
                                                            <button type="button" onclick="saveSickAdress()" class="btn btn-primary  m-btn--pill">保存</button>
                                                        </div>
                                                    </div>
                                                </div>

                                            </form>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    @section script{
        <script src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
        <script src="https://cdn.bootcss.com/bignumber.js/5.0.0/bignumber.min.js"></script>
        <script>
        /**/
        var data = [@Html.Raw(ViewBag.JsonData)];
        /**/
        $(document).ready(function () {
            //$('#J_modal_add_purchase').on('show.bs.modal', function (e) {
            //    $("#UserSilkAddress").val();
            //    $("#PublishId").val();
            //})

            $('#J_modal_add_purchase').on('hide.bs.modal', function (e) {
                $("#UserSilkAddress").val('');
                $("#PublishId").val('');
            })

            // 计算 data-scrollable data-max-height
            function setScrollMaxHT() {
                var windowHeight = mUtil.getViewPort().height;
                var vpt = windowHeight - 70 - 60 - 60 - 71 - 25;
                $('[data-scrollable="true"]').attr('data-max-height', vpt).css({
                    'height': vpt + 'px',
                    'max-height': vpt + 'px'
                });
            }
            setScrollMaxHT();

            /*
            $.fn.dataTable.ext.errMode = 'throw';
            $('#activityTable').DataTable({
                pageLength: 20,
                createdRow: function (row, data, index) {
                    $(row).addClass("rowDetails");
                },
                info: false,
                lengthChange: false,
                searching: false,
                ordering: false,
                processing: true,
                // serverSide: true,
                data: data,
                //ajax: '/Recharge/GetPurchaseRecord',
                columns: [{
                    data: 'time',
                    render: function (data, type, row, meta) {
                        return '<span class="text-nowrap">' + data + '</span>';
                    }
                }, {
                    data: 'type',
                    className: 'text-center',
                    render: function (data, type, row, meta) {
                        return '<span class="text-nowrap">' + data + ' </span> ';
                    }
                }, {
                    data: 'silk',
                    className: 'text-right',
                    render: function (data, type, row, meta) {

                        return '<span class="text-nowrap">' + data + '</span>';

    }
}, {
    data: 'eth',
    className: 'text-right',
    render: function (data, type, row, meta) {
        return '<span class="text-nowrap eth-color">' + data + ' ETH</span>';
    }
}, {
    data: 'btc',
    className: 'text-right',
    render: function (data, type, row, meta) {
        return '<span class="text-nowrap btc-color">' + data + ' BTC</span>';
    }
}, {
    data: 'lock',
    className: 'text-right',
    render: function (data, type, row, meta) {
        return '<span class="text-nowrap">' + data + ' </span> ';
    }
}
]
});*/

            });


            function showadress(publishid, silkadress) {
                $("#UserSilkAddress").val(silkadress);
                $("#PublishId").val(publishid);
                $('#J_modal_add_purchase').modal('show');
            }

            function saveSickAdress() {
                var silkadress = $("#UserSilkAddress").val();
                if (silkadress == '' || silkadress == null) {
                    alert("PLEASE ENTER YOUR SILK ADDRESS");
                    return;
                }
                var publishid = $("#PublishId").val();
                $.post('/Recharge/UpdateSickAdress', { PublishID: publishid, SickAdress: silkadress }, function (data) {
                    if (parseInt(data) >= 0) {
                        alert("保存成功");
                        location.reload();
                    }
                    else if (parseInt(data) == -1) {
                        LigerEP.ShowMsg("error", "认购记录记录不存在");
                    }
                    else {
                        LigerEP.ShowMsg("error", "该状态不能作此次操作");
                    }
                }, 'json')
            }

            function paid(publishid) {
                if (confirm("paid？")) {

                    $.post('/Recharge/SkcPublishPaid', { PublishID: publishid }, function (data) {
                        if (parseInt(data) >= 0) {
                            alert("操作成功");
                            location.reload();
                        }
                        else if (parseInt(data) == -1) {
                            alert("认购记录记录不存在");
                        }
                        else if (parseInt(data) == -3) {
                            alert("钱包地址不能为空");
                        }
                        else {
                            alert("该状态不能作此次操作");
                        }
                    }, 'json')
                }
            }
        </script>
    }

